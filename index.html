<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-10 Student Study Hub</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .app-container { min-height: 100vh; }
        /* Style the scrollbar in the chat area */
        .chat-area::-webkit-scrollbar {
            width: 8px;
        }
        .chat-area::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .chat-area {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <!-- Main Layout -->
    <div class="app-container flex flex-col md:flex-row gap-6 max-w-7xl mx-auto">

        <!-- Sidebar / Navigation -->
        <div class="md:w-64 w-full bg-white rounded-xl shadow-xl p-4 md:p-6 flex-shrink-0 h-fit sticky top-8">
            <div class="text-3xl font-extrabold text-indigo-600 mb-8 border-b pb-4">
                <span class="text-yellow-500">K-10</span> Study
            </div>

            <nav id="nav-buttons" class="space-y-3">
                <!-- Navigation buttons will be injected here -->
            </nav>

            <div class="mt-8 pt-4 border-t text-xs text-gray-500">
                <p>App ID: <span id="app-id-display"></span></p>
                <p class="mt-2">Student ID: <span id="user-id-display" class="font-mono text-indigo-500">Loading...</span></p>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="main-content" class="flex-grow min-h-[85vh]">
            <!-- Content will be injected here based on the active view -->
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================================
        // --- SECTION 1: CONFIGURATION & SERVICE LAYER (THE 'BACKEND' LOGIC) ---
        // ==========================================================

        // --- CONFIGURATION PLACEHOLDERS (!!! CRITICAL: REPLACE THESE !!!) ---
        // 🚨 IMPORTANT: You MUST replace all empty string values ("") with your actual credentials 
        // before deployment to GitHub/Render. Failing to do so will cause the 'auth/invalid-api-key' error.
        const PLACEHOLDER_FIREBASE_CONFIG = {
            // Get this from your Firebase Project Settings -> Web App Config
            apiKey: "", // <-- PASTE YOUR FIREBASE API KEY HERE!
            authDomain: "", // <-- PASTE YOUR AUTH DOMAIN HERE! (e.g., 'your-project-id.firebaseapp.com')
            projectId: "", // <-- PASTE YOUR PROJECT ID HERE! (e.g., 'your-project-id')
            storageBucket: "", 
            messagingSenderId: "", 
            appId: "" 
        };
        
        // This MUST match the path used in your Firestore Security Rules ('k10-study-hub').
        const PLACEHOLDER_APP_ID = "k10-study-hub"; 
        
        // Your key for the Gemini API (Get from Google AI Studio)
        const PLACEHOLDER_GEMINI_API_KEY = ""; // <-- PASTE YOUR GEMINI API KEY HERE!

        
        const appId = PLACEHOLDER_APP_ID;
        const firebaseConfig = PLACEHOLDER_FIREBASE_CONFIG;
        
        // --- FIREBASE INITIALIZATION ---
        // Note: The app will fail here if the API Key in firebaseConfig is invalid.
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = null;
        let isAuthReady = false;
        
        // Gemini API Configuration
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_KEY = PLACEHOLDER_GEMINI_API_KEY;

        // --- AUTHENTICATION SERVICE ---
        window.initAuth = () => {
            document.getElementById('app-id-display').textContent = appId;
            
            // Default to anonymous sign-in for public hosting
            signInAnonymously(auth).then((userCred) => {
                userId = userCred.user.uid;
                document.getElementById('user-id-display').textContent = formatUserId(userId);
                isAuthReady = true;
                window.renderApp(); 
            }).catch((error) => {
                // This catch block handles the 'auth/invalid-api-key' error
                console.error("Firebase Auth Error: Failed to sign in anonymously. Check your API Key.", error);
                userId = 'auth-error';
                document.getElementById('user-id-display').textContent = 'API Key Error';
                isAuthReady = true;
                window.renderApp();
            });
        };

        // --- CHAT SERVICE (Firestore) ---
        const CHAT_COLLECTION_PATH = `artifacts/${appId}/public/data/chat_messages`;

        window.setupChatListener = () => {
            if (!db || !isAuthReady) return;

            const messagesRef = collection(db, CHAT_COLLECTION_PATH);
            const q = query(messagesRef, orderBy('timestamp', 'asc'), limit(50));

            const unsubscribe = onSnapshot(q, (snapshot) => {
                const messages = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp?.toDate() || new Date()
                }));
                window.renderChatMessages(messages);
            }, (error) => {
                console.error("Error listening to chat:", error);
            });
            return unsubscribe;
        };

        window.sendMessage = async (messageText) => {
            if (!db || !userId || !messageText.trim()) return;

            try {
                await addDoc(collection(db, CHAT_COLLECTION_PATH), {
                    userId: userId,
                    text: messageText,
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error("Error sending message:", e);
                // Handle UI feedback for failure if needed
            }
        };

        // --- AI DOUBT SOLVER SERVICE (Gemini API) ---
        window.fetchGeminiResponse = async (userQuery) => {
            // Note: This API call relies on the PLACEHOLDER_GEMINI_API_KEY being correctly filled above
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
            
            const systemPrompt = "You are 'EduBot', a friendly and encouraging tutor for K-10 students (Grade 1 to 10). Your goal is to solve doubts, explain concepts clearly, and guide the student towards understanding. Keep your answers concise, clear, and age-appropriate.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Gemini API Error details:", errorBody);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't process that question right now. Try again!";
                
                return text;

            } catch (error) {
                console.error("Gemini API call failed:", error);
                return "There was an issue connecting to the doubt-solver AI. Please ensure your Gemini API Key is valid and your Firebase Auth is working.";
            }
        };


        // ==========================================================
        // --- SECTION 2: UI LAYER (THE 'INDEX' LOGIC) ---
        // ==========================================================

        let activeView = 'Home';
        const mainContent = document.getElementById('main-content');
        const views = ['Home', 'AI Solver', 'Mock Tests', 'Community Chat'];
        let chatUnsubscribe = null; 

        window.setActiveView = (viewName) => {
            activeView = viewName;
            
            if (chatUnsubscribe && viewName !== 'Community Chat') {
                chatUnsubscribe();
                chatUnsubscribe = null;
            }
            
            window.renderApp();
            
            if (viewName === 'Community Chat' && !chatUnsubscribe) {
                chatUnsubscribe = window.setupChatListener();
            }
        };

        const formatUserId = (id) => {
            if (!id || id === 'auth-error') return "Guest/Error";
            return `${id.substring(0, 4)}...${id.substring(id.length - 4)}`;
        };


        // --- UI Rendering Functions ---

        window.renderApp = () => {
            if (!isAuthReady) {
                 mainContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full bg-white rounded-xl shadow-lg p-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                        <p class="mt-4 text-lg text-indigo-600">Connecting to Study Hub...</p>
                    </div>
                `;
                return;
            }

            // Render Navigation
            const navButtonsContainer = document.getElementById('nav-buttons');
            navButtonsContainer.innerHTML = views.map(item => `
                <button
                    onclick="window.setActiveView('${item}')"
                    class="w-full text-left flex items-center p-3 rounded-xl transition-all 
                        ${activeView === item ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-700 hover:bg-indigo-50 hover:text-indigo-600'}"
                >
                    <span class="mr-3 text-lg">
                        ${item === 'Home' ? '🏠' : item === 'AI Solver' ? '🤖' : item === 'Mock Tests' ? '📚' : '💬'}
                    </span>
                    <span class="font-medium">${item}</span>
                </button>
            `).join('');

            // Render Main Content
            switch (activeView) {
                case 'AI Solver':
                    renderAIDoubtSolver();
                    break;
                case 'Mock Tests':
                    renderStudyMaterials();
                    break;
                case 'Community Chat':
                    renderChatRoom();
                    break;
                case 'Home':
                default:
                    renderHome();
                    break;
            }
        };
        
        // --- VIEW TEMPLATES ---

        const renderHome = () => {
            mainContent.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-8 h-full flex flex-col justify-center items-center text-center">
                    <h1 class="text-4xl font-extrabold text-indigo-700 mb-4">Welcome to the Student Study Hub!</h1>
                    <p class="text-xl text-gray-600 mb-8">Your integrated platform for doubt solving, practice tests, and connecting with peers.</p>
                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-6">
                        <button
                            onclick="window.setActiveView('AI Solver')"
                            class="px-8 py-4 bg-green-500 text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-green-600 transition-transform transform hover:scale-105"
                        >
                            🤖 Solve a Doubt
                        </button>
                        <button
                            onclick="window.setActiveView('Mock Tests')"
                            class="px-8 py-4 bg-yellow-500 text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-yellow-600 transition-transform transform hover:scale-105"
                        >
                            📚 Take a Mock Test
                        </button>
                        <button
                            onclick="window.setActiveView('Community Chat')"
                            class="px-8 py-4 bg-red-500 text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-red-600 transition-transform transform hover:scale-105"
                        >
                            💬 Join the Chat
                        </button>
                    </div>
                </div>
            `;
        };

        const renderAIDoubtSolver = () => {
            mainContent.innerHTML = `
                <div class="bg-white rounded-xl shadow-lg p-6 h-full flex flex-col">
                    <h2 class="text-2xl font-bold text-indigo-700 mb-4">🤖 AI Doubt Solver (EduBot)</h2>
                    <p class="text-gray-600 mb-6">Type your question below, and EduBot will provide a clear, easy-to-understand answer suitable for K-10 students.</p>

                    <form id="doubt-solver-form" class="flex flex-col space-y-4 mb-6">
                        <textarea
                            id="doubt-query"
                            placeholder="e.g., What is a compound sentence? or Explain the water cycle."
                            rows="3"
                            class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none"
                            required
                        ></textarea>
                        <button
                            type="submit"
                            id="solve-doubt-btn"
                            class="w-full py-3 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition-colors disabled:bg-green-300 flex items-center justify-center"
                        >
                            Solve Doubt
                        </button>
                    </form>
                    
                    <div class="flex-grow bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-600 overflow-y-auto">
                        <h3 class="font-semibold text-indigo-800 mb-2">EduBot's Answer:</h3>
                        <div id="doubt-response" class="whitespace-pre-wrap text-gray-700 text-sm">
                            Ask me any doubt in English, Math, or Science from your Grade 1-10 syllabus!
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('doubt-solver-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const queryInput = document.getElementById('doubt-query');
                const responseDiv = document.getElementById('doubt-response');
                const submitBtn = document.getElementById('solve-doubt-btn');
                const query = queryInput.value.trim();

                if (!query) return;

                // Disable button and show loading state
                submitBtn.disabled = true;
                submitBtn.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Solving Doubt...
                `;
                responseDiv.textContent = "Thinking... EduBot is finding the perfect explanation for you...";

                // Call the service layer function
                const result = await window.fetchGeminiResponse(query);
                
                // Update UI
                responseDiv.textContent = result;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Solve Doubt';
                queryInput.value = '';
            });
        };
        
        const renderChatRoom = () => {
            mainContent.innerHTML = `
                <div class="flex flex-col h-full bg-white rounded-xl shadow-lg p-4">
                    <h2 class="text-2xl font-bold text-indigo-700 border-b pb-2 mb-4">Community Chat (Grade 1-10)</h2>
                    <p class="text-sm text-gray-500 mb-2">
                        Your ID: <span class="font-mono text-xs bg-gray-100 px-1 py-0.5 rounded-md text-indigo-500">${formatUserId(userId)}</span>
                    </p>

                    <!-- Message List -->
                    <div id="chat-messages" class="chat-area flex-grow overflow-y-auto space-y-3 p-2 bg-gray-50 rounded-lg mb-4">
                        <div class="text-center text-gray-500 mt-10">Loading messages...</div>
                    </div>

                    <!-- Input Form -->
                    <form id="chat-form" class="flex">
                        <input
                            type="text"
                            id="chat-input"
                            placeholder="Type your message here..."
                            class="flex-grow p-3 border border-gray-300 rounded-l-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100"
                            ${isAuthReady ? '' : 'disabled'}
                        />
                        <button
                            type="submit"
                            id="chat-send-btn"
                            class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-r-xl hover:bg-indigo-700 transition-colors disabled:bg-indigo-300"
                            ${isAuthReady ? '' : 'disabled'}
                        >
                            Send
                        </button>
                    </form>
                </div>
            `;
            
            document.getElementById('chat-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                window.sendMessage(input.value); // Call the service layer function
                input.value = '';
            });
        };
        
        window.renderChatMessages = (messages) => {
            const container = document.getElementById('chat-messages');
            if (!container) return;
            
            // Determine if the user was near the bottom before update
            const wasAtBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 100; 

            if (messages.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 mt-10">Start the conversation! Say hello.</div>`;
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isCurrentUser = msg.userId === userId;
                const time = msg.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <div class="flex ${isCurrentUser ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-lg shadow-md 
                            ${isCurrentUser ? 'bg-indigo-500 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-tl-none'}">
                            ${!isCurrentUser ? `<span class="block text-xs font-semibold mb-1 opacity-80">${formatUserId(msg.userId)}</span>` : ''}
                            <p class="text-sm">${msg.text}</p>
                            <span class="block text-[10px] opacity-70 mt-1">${time}</span>
                        </div>
                    </div>
                `;
            }).join('');

            if (wasAtBottom) {
                container.scrollTop = container.scrollHeight;
            }
        };

        const renderStudyMaterials = () => {
             // Mock data (static in this client-side implementation)
            const materials = {
                'English': [
                    { id: 1, title: "Grade 5: Verb Tenses Mock Test", type: "Test", grade: 5 },
                    { id: 2, title: "Grade 8: Passive Voice Sample Paper", type: "Paper", grade: 8 },
                    { id: 3, title: "Grade 10: Literary Devices Practice Quiz", type: "Quiz", grade: 10 },
                ],
                'Math': [
                    { id: 4, title: "Grade 3: Multiplication Basics Test", type: "Test", grade: 3 },
                    { id: 5, title: "Grade 7: Algebra Introduction Paper", type: "Paper", grade: 7 },
                ],
            };
            
            let activeSubject = 'English';
            let activeTest = null;
            
            const updateMaterialsUI = () => {
                // If a test is active, show the test view
                if (activeTest) {
                    mainContent.innerHTML = `
                        <div class="bg-white rounded-xl shadow-lg p-6 h-full flex flex-col">
                            <button
                                onclick="activeTest = null; updateMaterialsUI()"
                                class="self-start mb-4 text-indigo-600 hover:text-indigo-800 transition-colors"
                            >
                                &larr; Back to Materials
                            </button>
                            <h2 class="text-3xl font-bold text-indigo-700 mb-4">${activeTest.title}</h2>
                            <div class="flex-grow bg-yellow-50 border-l-4 border-yellow-600 p-4 rounded-lg">
                                <p class="text-lg text-yellow-800 font-semibold mb-4">Question 1: Fill in the blank (Grade ${activeTest.grade})</p>
                                <div class="bg-white p-4 rounded-md shadow-inner">
                                    <p class="mb-4">She _____ (go) to school yesterday.</p>
                                    <input type="text" placeholder="Your Answer" class="p-2 border rounded-md w-full max-w-sm"/>
                                </div>
                                <p class="mt-8 text-sm text-gray-500">
                                    This is a placeholder for a functional mock test or sample paper system.
                                </p>
                                <button class="mt-6 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">
                                    Submit Answer
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }

                // Otherwise, show the subject selection and list
                mainContent.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-6 h-full flex flex-col">
                        <h2 class="text-2xl font-bold text-indigo-700 mb-4">Mock Tests & Sample Papers</h2>

                        <div id="subject-tabs" class="flex space-x-4 mb-6 border-b pb-2">
                            <!-- Tabs here -->
                        </div>

                        <div id="material-list" class="space-y-4 overflow-y-auto">
                            <!-- Material list here -->
                        </div>
                    </div>
                `;

                const subjectTabs = document.getElementById('subject-tabs');
                subjectTabs.innerHTML = Object.keys(materials).map(subject => `
                    <button
                        onclick="activeSubject = '${subject}'; updateMaterialsUI()"
                        class="px-4 py-2 font-semibold rounded-lg transition-all ${
                            activeSubject === subject ? 'bg-indigo-500 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }"
                    >
                        ${subject}
                    </button>
                `).join('');

                const materialList = document.getElementById('material-list');
                materialList.innerHTML = materials[activeSubject].map(item => `
                    <div
                        class="flex justify-between items-center p-4 bg-gray-50 border border-gray-200 rounded-lg hover:shadow-md transition-shadow"
                    >
                        <div>
                            <p class="text-lg font-semibold text-gray-800">${item.title}</p>
                            <span class="text-sm text-indigo-500 bg-indigo-100 px-2 py-0.5 rounded-full">${item.type} (Grade ${item.grade})</span>
                        </div>
                        <button
                            onclick="activeTest = ${JSON.stringify(item).replace(/"/g, '&quot;')}; updateMaterialsUI()"
                            class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-full hover:bg-indigo-700 transition-colors"
                        >
                            Start
                        </button>
                    </div>
                `).join('');
            };

            // Initial call to render the materials section
            updateMaterialsUI();
        };


        // --- ENTRY POINT ---
        window.addEventListener('load', () => {
            window.initAuth();
            window.renderApp(); 
        });

    </script>
</body>
</html>
